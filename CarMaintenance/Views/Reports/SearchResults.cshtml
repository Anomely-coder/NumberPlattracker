@using System.Globalization
@model List<CarMaintenance.Models.ViewModels.SearchResultViewModel>
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> Localizer

@{
    var searchTerm = ViewData["SearchTerm"] as string;
    var generatedBy = ViewData["GeneratedBy"] as string ?? Localizer["UnknownUser"];
    bool isRtl = CultureInfo.CurrentCulture.TextInfo.IsRightToLeft;
}

<!-- jQuery UI & PDF libraries -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<section class="content-header">
    <div class="container-fluid">
        <h2>@Localizer["SearchResultsTitle"]</h2>
        <form id="searchForm" asp-controller="Reports" asp-action="Search" method="get" class="form-inline mb-3">
            <div id="searchTerm-wrapper" style="position:relative; display:inline-block;">
                <input type="text" id="searchTerm" name="searchTerm" class="form-control mr-2" value="@searchTerm" placeholder="Search..." autocomplete="off" />
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
</section>

<section class="content">
    @if (!Model.Any())
    {
        <div class="alert alert-warning">No results found.</div>
    }
    else
    {
        <div id="pdfContent" style="font-family:'Arial'; width:100%; text-align:@(isRtl ? "right" : "left"); direction:@(isRtl ? "rtl" : "ltr");">
            <h2 style="text-align:center;">@Localizer["CustomerReport"]</h2>
            <div style="display:flex; justify-content:space-between;">
                <span>@Localizer["GeneratedBy"]: @generatedBy</span>
                <span>@Localizer["GeneratedOn"]: @DateTime.Now.ToString("MM/dd/yyyy HH:mm")</span>
            </div>
            <hr />

            @foreach (var r in Model)
            {
                var customer = r.Customer;
                <div style="margin-bottom:20px; border-bottom:1px solid #ccc; padding-bottom:10px;">
                    <p><strong>@Localizer["CustomerName"]:</strong> @customer.Name</p>
                    <p><strong>@Localizer["Email"]:</strong> @customer.Email</p>
                    <p><strong>@Localizer["NumberPlate"]:</strong> @(customer.Cars?.NumberPlate ?? Localizer["NotAvailable"])</p>

                    <!-- Receipts Table -->
                    @if (customer.Receipts?.Any() ?? false)
                    {
                        <p style="font-weight:bold; margin-top:10px;">@Localizer["Receipts"]:</p>
                        <table border="1" style="width:100%; border-collapse:collapse; text-align:@(isRtl ? "right" : "left");">
                            <thead style="background-color:#16a085; color:white;">
                                <tr>
                                    <th>@Localizer["Date"]</th>
                                    <th>@Localizer["Amount"]</th>
                                    <th>@Localizer["ServicesLabel"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var rec in customer.Receipts)
                                {
                                    var servicesText = string.Join(", ", rec.ReceiptsDetails?.Select(d => d.Services?.ServiceName ?? "N/A"));
                                    <tr>
                                        <td>@rec.Date.ToShortDateString()</td>
                                        <td>@rec.TotalAmount.ToString("F2")</td>
                                        <td>@servicesText</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    <!-- Transfers Table -->
                    @if (r.Transfers?.Any() ?? false)
                    {
                        <p style="font-weight:bold; margin-top:10px;">@Localizer["Transfers"]:</p>
                        <table border="1" style="width:100%; border-collapse:collapse; text-align:@(isRtl ? "right" : "left");">
                            <thead style="background-color:#27ae60; color:white;">
                                <tr>
                                    <th>@Localizer["From"]</th>
                                    <th>@Localizer["To"]</th>
                                    <th>@Localizer["DateLabel"]</th>
                                    <th>@Localizer["NumberPlate"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in r.Transfers)
                                {
                                    <tr>
                                        <td>@(t.FromCustomers?.Name ?? Localizer["NotAvailable"])</td>
                                        <td>@(t.ToCustomers?.Name ?? Localizer["NotAvailable"])</td>
                                        <td>@t.TransferDate.ToShortDateString()</td>
                                        <td>@(t.Cars?.NumberPlate ?? Localizer["NotAvailable"])</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            }
        </div>

        <button id="exportPdfBtn" class="btn btn-danger mt-3">Export to PDF</button>
    }
</section>

@section Scripts {
    <script>
        $(function() {
            // Autocomplete
            $("#searchTerm").autocomplete({
                minLength: 1,
                delay: 100,
                source: function(request, response) {
                    $.getJSON('@Url.Action("GetSearchSuggestions", "Reports")', { term: request.term }, response);
                },
                select: function(event, ui) {
                    $("#searchTerm").val(ui.item.value);
                    $("#searchForm").submit();
                },
                appendTo: "#searchTerm-wrapper"
            }).data("ui-autocomplete")._renderItem = function(ul, item) {
                return $("<li>")
                    .append("<div style='padding:5px;'>" + item.label + "</div>")
                    .appendTo(ul);
            };

            $(".ui-autocomplete").css({
                "max-height": "200px",
                "overflow-y": "auto",
                "overflow-x": "hidden",
                "z-index": "10000"
            });

            // PDF Export
            $("#exportPdfBtn").click(function() {
                html2canvas(document.getElementById("pdfContent"), { scale: 2, useCORS: true }).then(function(canvas) {
                    const { jsPDF } = window.jspdf;
                    var pdf = new jsPDF('p', 'pt', 'a4');
                    var imgData = canvas.toDataURL('image/png');
                    var pageWidth = pdf.internal.pageSize.getWidth();
                    var pageHeight = pdf.internal.pageSize.getHeight();
                    var imgWidth = pageWidth;
                    var imgHeight = canvas.height * imgWidth / canvas.width;
                    var heightLeft = imgHeight;
                    var position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save("CustomerReport.pdf");
                });
            });
        });
    </script>
}
