@model List<CarMaintenance.Models.ViewModels.SearchResultViewModel>

@{
    ViewData["Title"] = "Search Results";
    var searchTerm = ViewData["SearchTerm"] as string;
    var generatedBy = ViewData["GeneratedBy"] as string ?? "Unknown User";
}

<section class="content-header">
    <div class="container-fluid">
        <h2>Search Results</h2>
        <p><strong>Generated By:</strong> @generatedBy</p>
        <p><strong>Generated On:</strong> @DateTime.Now.ToString("MM/dd/yyyy HH:mm")</p>
    </div>
</section>

<section class="content">
    <form asp-controller="Reports" asp-action="Search" method="get" class="form-inline mb-3">
        <input type="text" name="searchTerm" class="form-control mr-2" value="@searchTerm" placeholder="Search..." />
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    @if (!Model.Any())
    {
        <div class="alert alert-warning">No results found.</div>
    }
    else
    {
        <table class="table table-bordered table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Number Plate</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model)
                {
                    var customer = r.Customer;
                    <tr>
                        <td>@customer.Name</td>
                        <td>@customer.Email</td>
                        <td>@(customer.Cars?.NumberPlate ?? "N/A")</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Export PDF Button -->
        <div class="mt-3">
            <button id="exportPdfBtn" class="btn btn-danger">Export to PDF</button>
        </div>
    }
</section>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        document.getElementById("exportPdfBtn").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            // Header
            doc.setFontSize(16);
            doc.text("Customer Report", 14, y);
            y += 8;
            doc.setFontSize(11);
            doc.text("Generated By: @generatedBy", 14, y);
            y += 6;
            doc.text("Generated On: @DateTime.Now.ToString("MM/dd/yyyy HH:mm")", 14, y);
            y += 10;

            @foreach (var r in Model)
            {
                    var customer = r.Customer;

                    <text>
                    // Customer Info Table
                    doc.autoTable({
                        startY: y,
                        head: [['Customer Name', 'Email', 'Number Plate']],
                        body: [['@customer.Name', '@customer.Email', '@(customer.Cars?.NumberPlate ?? "N/A")']],
                        theme: 'grid',
                        headStyles: { fillColor: [52, 73, 94] },
                        styles: { fontSize: 10 }
                    });
                    y = doc.lastAutoTable.finalY + 4;

                    // Receipts Table
                    if (@(customer.Receipts?.Count() ?? 0) > 0) {
                        const receiptsBody = [];
                        @foreach (var rec in customer.Receipts)
                        {
                                var services = rec.ReceiptsDetails?.Select(d => d.Services?.ServiceName ?? "N/A").ToList() ?? new List<string>();
                                var servicesText = string.Join(", ", services);
                                <text>
                                receiptsBody.push(['@rec.Date.ToShortDateString()', '@rec.TotalAmount.ToString("F2")', '@servicesText']);
                                </text>
                        }
                        doc.autoTable({
                            startY: y,
                            head: [['Date', 'Amount', 'Services']],
                            body: receiptsBody,
                            theme: 'grid',
                            headStyles: { fillColor: [22, 160, 133] },
                            styles: { fontSize: 9 }
                        });
                        y = doc.lastAutoTable.finalY + 4;
                    }

                    // Transfers Table
                    if (@(r.Transfers?.Count() ?? 0) > 0) {
                        const transfersBody = [];
                        @foreach (var t in r.Transfers)
                        {
                                <text>
                                transfersBody.push(['@(t.FromCustomers?.Name ?? "N/A")', '@(t.ToCustomers?.Name ?? "N/A")', '@t.TransferDate.ToShortDateString()', '@(t.Cars?.NumberPlate ?? "N/A")']);
                                </text>
                        }
                        doc.autoTable({
                            startY: y,
                            head: [['From', 'To', 'Date', 'Number Plate']],
                            body: transfersBody,
                            theme: 'grid',
                            headStyles: { fillColor: [39, 174, 96] },
                            styles: { fontSize: 9 }
                        });
                        y = doc.lastAutoTable.finalY + 8;
                    }

                    // Spacer between customers
                    y += 4;
                    </text>
            }

            doc.save("CustomerReport.pdf");
        });
    </script>
}
